#!/usr/bin/env bash

set -e

arch=x86_64
if arch -arch arm64 date >/dev/null 2>&1; then
    arch=arm64
fi

status() {
	ppid=$(/bin/ps ax | grep plumber | grep -v grep | awk '{print $1}')

	if [[ $ppid ]]; then
		echo "$ppid"
	fi
	unset ppid
}

start() {
	if [ ! "$pid" ]; then
		arch -arch $arch "$PLAN9"/bin/plumber
		return $?
	fi
	return 0
}

stop() {
	if [[ $pid ]]; then
		/bin/kill -9 "$pid" 2> /dev/null
	fi
	unset pid
	return $?
}

PLAN9=${PLAN9:-/usr/local/plan9}

if [ ! -x "$PLAN9"/bin/plumber ]; then
	exit 1
fi

pid=$(status)

case $1 in
start)
	start;;
stop)
	stop;;
status)
	echo "$pid";;
restart)
	stop
	start;;
*)
	echo 2>&1 "p9plumb [start | stop | restart | status ]"
	exit 1;;
esac
