#!/usr/bin/env bash

if [ $#winid = 0 ]; then
	echo "Acme is not running"
	exit 1
fi

ROOT=$(dirname $PWD)
SEL=$(9p read acme/"$winid"/rdsel)
PATTALL="((class|def)\s*$SEL\b\s*\(?|^\s*\b$SEL(:?\s\w*)\s*=[^=\n]+)"
R=$(rg -n -tpy -e $PATTALL $ROOT)
COUNT=${#R[@]}

if [ $COUNT = "0" ]; then
	fname=$(echo $R | cut -d ':' -f1)
	loc=$(echo $R | cut -d ':' -f2)
	plumb -d edit -a 'action=showfile addr='$loc $fname
else
	echo "$R" | plumb -i -d edit -a 'action=showdata filename=+pyref'
fi
exit 0
